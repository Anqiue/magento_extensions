<?php
/**
 * @category   Php4u
 * @package    Php4u_BlastLuceneSearch
 * @author     Marcin Szterling <marcin@php4u.co.uk>
 * @copyright  Php4u Marcin Szterling (c) 2011
 * @license http://php4u.co.uk/licence/
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 * Any form of ditribution, sell, transfer forbidden, reverse engineering forbidden - see licence above
 *
 * Code was obfusacted due to previous licence violations
 */
class Php4u_BlastLuceneSearch_Block_Adminhtml_Blastlucenesearch extends Mage_Adminhtml_Block_Template { 
    public function __construct() { $this->_controller = 'adminhtml_blastlucenesearch'; $this->_blockGroup = 'blastlucenesearch'; $this->_headerText = Mage::helper('php4u')->__('Blast Search Lucene Diagnostics v2.0'); parent::__construct(); } protected function _toHtml() { $_1064f7656ff7b04347e4d8505973d388 = '<h2>Blast Search Lucene Diagnostics v2.1</h2>'; $_1064f7656ff7b04347e4d8505973d388 .= '<h3>License</h3><p>License information is available on extension settings screen (store level view)</p>'; $_37571e10d643e859072b50e5ed0892f4 = Mage::getSingleton('blastlucenesearch/blastlucenesearch')->getVersion(); $_1064f7656ff7b04347e4d8505973d388 .= '<h3>Installation</h3>'; $_294a7fe923b85803c00bc934ec87abdf = Mage::getSingleton('core/resource')->getConnection('core_read'); $_88999f55c4ee1ce1347d6dda4289b532 = $_294a7fe923b85803c00bc934ec87abdf->fetchOne("SELECT attribute_id FROM `".Mage::getSingleton('core/resource')->getTableName('eav_attribute')."` WHERE `attribute_code` LIKE 'lucene_indexed';"); if ($_88999f55c4ee1ce1347d6dda4289b532 < 1 || empty($_88999f55c4ee1ce1347d6dda4289b532) ) { $_1064f7656ff7b04347e4d8505973d388 .= '<strong>PROBLEM with installation! (1)</strong><br/><i>Migration scripts were not run by Magento, happens with extensively caching. Contact support or see <a href="https://php4u.zendesk.com/entries/20717108-how-to-upgrade-to-latest-version-of-the-extension" target="blank">here (pkt 5)</a></i>'; } else { $_1064f7656ff7b04347e4d8505973d388 .= '<p>EAV looks ok - attribute 1 present</p>'; } $_88999f55c4ee1ce1347d6dda4289b532 = $_294a7fe923b85803c00bc934ec87abdf->fetchOne("SELECT attribute_id FROM `".Mage::getSingleton('core/resource')->getTableName('eav_attribute')."` WHERE `attribute_code` LIKE 'lucene_product_position';"); if ($_88999f55c4ee1ce1347d6dda4289b532 < 1 || empty($_88999f55c4ee1ce1347d6dda4289b532) ) { $_1064f7656ff7b04347e4d8505973d388 .= '<strong>PROBLEM with installation! (2)</strong><br/><i>Migration scripts were not run by Magento, happens with extensively caching. Contact support or see <a href="https://php4u.zendesk.com/entries/20717108-how-to-upgrade-to-latest-version-of-the-extension" target="blank">here (pkt 5)</a></i>'; } else { $_1064f7656ff7b04347e4d8505973d388 .= '<p>EAV looks ok - attribute 2 present</p>'; } $_c93b309b40d13c26521ca5b11d4f6c97 = $_294a7fe923b85803c00bc934ec87abdf->fetchOne("SELECT version FROM `".Mage::getSingleton('core/resource')->getTableName('core_resource')."` WHERE `code` LIKE 'blastlucenesearch_setup';"); $_1064f7656ff7b04347e4d8505973d388 .= "<p>Module version in database (core_resource) $_c93b309b40d13c26521ca5b11d4f6c97, module (config.xml) $_37571e10d643e859072b50e5ed0892f4 - OK</p>"; if (version_compare($_c93b309b40d13c26521ca5b11d4f6c97,$_37571e10d643e859072b50e5ed0892f4) !== 0) { $_1064f7656ff7b04347e4d8505973d388 .= '<strong>PROBLEM with installation!</strong><br/><i>In database there is different version of the module than in file. Problem with cache?</i>'; } $_1064f7656ff7b04347e4d8505973d388 .= '<h3>Php & Server</h3>'; $_1064f7656ff7b04347e4d8505973d388 .= '<p>Php version: '.phpversion().'</p>'; $_1064f7656ff7b04347e4d8505973d388 .= '<p>Server software: '.$_SERVER['SERVER_SOFTWARE'].'</p>'; $_1064f7656ff7b04347e4d8505973d388 .= '<p>PHP Log errors?: '.(ini_get('log_errors')?'Yes':'No').'</p>'; $_1064f7656ff7b04347e4d8505973d388 .= '<p>PHP Error log: '.ini_get('error_log').'</p>'; $_1064f7656ff7b04347e4d8505973d388 .= '<p>PHP execution time limit: '.(ini_get('max_execution_time')/100).'s</p>'; $_1064f7656ff7b04347e4d8505973d388 .= '<p><i>This can have impact on lucene index generation time, increase if you have a lot of SKUs</i></p>'; $_1064f7656ff7b04347e4d8505973d388 .= '<p>Memory limit: '.ini_get('memory_limit').'</p>'; $_1064f7656ff7b04347e4d8505973d388 .= '<p><i>Info: Memory is required to generate index, optimize it and search so make sure that you have enough</i></p>'; $_1064f7656ff7b04347e4d8505973d388 .= '<h3>Magento General</h3>'; $_1064f7656ff7b04347e4d8505973d388 .= '<p>Is extension enabled? '. (Mage::getStoreConfig('php4u/php4u_group/php4u_lucene_enabled') ? 'OK: Yes':'Error: No') . '</p>'; if (Mage::getStoreConfig('php4u/php4u_group/php4u_lucene_enabled') == 0) { $_1064f7656ff7b04347e4d8505973d388 .= "<p><i>go to System -> Configuration -> Php4u Extensions and enable it</i></p>"; } if (Mage::getStoreConfigFlag('php4u/php4u_group/php4u_lucene_onlynew',Mage::app()->getStore())) { $_1064f7656ff7b04347e4d8505973d388 .= "<p>Only new products will be indexed</p>"; $_1064f7656ff7b04347e4d8505973d388 .= "<p>Below in index section check how many products require indexing</p>"; } else { $_1064f7656ff7b04347e4d8505973d388 .= "<p>All products will be indexed, you can index only new products if required</p>"; $_1064f7656ff7b04347e4d8505973d388 .= "<p><i>go to System -> Configuration -> Php4u Extensions and enable it</i></p>"; } $_1064f7656ff7b04347e4d8505973d388 .= '<h3>Logs</h3>'; $_03621b5206eae75fbd8a022a8cad3a71 = Mage::getBaseDir('var').DS.'log'; $_958783b7bef220ed1e8f9cfc50be4656 = Mage::getBaseDir('var').DS.'indexer'; $_46b8a7d04fc9b5a3de69a66551c58852 = $_03621b5206eae75fbd8a022a8cad3a71 . DS .'blastlucenesearch.log'; $_1064f7656ff7b04347e4d8505973d388 .= '<p>Is logging enabled in magento? '. (Mage::getStoreConfig('dev/log/active') ? 'OK: Yes':'Error: No') . '</p>'; if (Mage::getStoreConfig('dev/log/active') == 0) { $_1064f7656ff7b04347e4d8505973d388 .= "<p>Error: <i>{$_46b8a7d04fc9b5a3de69a66551c58852} file will NOT be produced, go to System -> Configuration -> Development and enable log files</i></p>"; } else { $_1064f7656ff7b04347e4d8505973d388 .= "<p>OK: log file is located here : <strong>{$_46b8a7d04fc9b5a3de69a66551c58852}</strong></p>"; } $_1064f7656ff7b04347e4d8505973d388 .= "<p>".(is_file($_46b8a7d04fc9b5a3de69a66551c58852) ? 'OK: File exists':'Error: File not exists')."</p>"; $_1064f7656ff7b04347e4d8505973d388 .= "<p>".(is_writable($_46b8a7d04fc9b5a3de69a66551c58852) ? 'OK: File is writable ':"Error: File is not writable. Check permissions to <strong>{$_03621b5206eae75fbd8a022a8cad3a71}</strong> folder")."</p>"; if (is_file($_46b8a7d04fc9b5a3de69a66551c58852)) { $_bce3a92866fd411af0b7fdd104745557 = stat($_46b8a7d04fc9b5a3de69a66551c58852); $_1064f7656ff7b04347e4d8505973d388 .= "<p>Last modification time: <strong>".date(DATE_RFC822,$_bce3a92866fd411af0b7fdd104745557['mtime'])."</strong></p>"; $_1064f7656ff7b04347e4d8505973d388 .= '<style type="text/css">        <!--        div.scroll {        height: 200px;        width: 99%;        overflow: auto;        border: 1px solid #666;        background-color: #ccc;        padding: 8px;        }        -->        </style> '; $_1064f7656ff7b04347e4d8505973d388 .= "<p>Last entries: (will refresh every 10 seconds)<br/><div class=\"scroll\" id=\"log\">" . implode("<br/>",$this->read_file($_46b8a7d04fc9b5a3de69a66551c58852, 100)). "</div></p>"; } $_1064f7656ff7b04347e4d8505973d388 .= '<h3>Lucene Indexes</h3>'; if (@preg_match('/\pL/u', 'a') != 1) { $_1064f7656ff7b04347e4d8505973d388 .= '<p>Error: Utf8Num analyzer needs PCRE unicode support to be enabled.</p>'; } else { $_1064f7656ff7b04347e4d8505973d388 .= '<p>OK. PCRE unicode detected.</p>'; } if (!function_exists('mb_strlen')) { $_1064f7656ff7b04347e4d8505973d388 .= '<p>Error: Utf8Num analyzer needs mb_string extension. Check <a href="http://www.php.net/manual/en/mbstring.installation.php">Manual page</a></p>'; } else { $_1064f7656ff7b04347e4d8505973d388 .= '<p>OK. mb_string detected.</p>'; } $_1064f7656ff7b04347e4d8505973d388 .= "<p>Main indexer folder <strong>$_958783b7bef220ed1e8f9cfc50be4656</strong> ".(is_dir($_958783b7bef220ed1e8f9cfc50be4656) ? 'OK: Directory exists':'Error: Directory not exists')."</p>"; if (!is_dir($_958783b7bef220ed1e8f9cfc50be4656)) { $_1064f7656ff7b04347e4d8505973d388 .= "<p><i>Check ".Mage::getBaseDir('var')." folder permissions and then Refresh Search Lucene index (System -> Cache Management) </i></p>"; } else { $_1064f7656ff7b04347e4d8505973d388 .= "<br/><h4>Directories present (Check number of products in Lucene index folder below):</h4><br/>"; $_1064f7656ff7b04347e4d8505973d388 .= '<div id="stats-table">' . Mage::helper('php4u')->getAdminStatsTable($_958783b7bef220ed1e8f9cfc50be4656) . '</div>'; $_1064f7656ff7b04347e4d8505973d388 .= "</p>"; } $_82c4120b582ee44ea0595d2db35c38c6 = Mage::helper("adminhtml")->getUrl("blastlucenesearch/adminhtml_blastlucenesearch/log/"); $_89f44551e6b736ee93c6c6253fa4c061 = Mage::helper("adminhtml")->getUrl("blastlucenesearch/adminhtml_blastlucenesearch/stats/"); $_1064f7656ff7b04347e4d8505973d388 .= "             <script>             Event.observe(window, 'load', function() {                 with ($('log')) {scrollTop = scrollHeight;}              new Ajax.PeriodicalUpdater('log', '$_82c4120b582ee44ea0595d2db35c38c6', {        method: 'get', frequency: 10, decay: 5     });     new Ajax.PeriodicalUpdater('stats-table', '$_89f44551e6b736ee93c6c6253fa4c061', {        method: 'get', frequency: 10, decay: 5     });     });     </script>             "; return $_1064f7656ff7b04347e4d8505973d388; } public function _getElementHtml() { return ''; } function read_file($_b23a6623f301abe9dc853f87ef4e1bdf, $_e3f4c2e7eaad8039fc9ce37042c9f3ff) { $_699f8e535a4b8ec5e03224497c24306e = fopen($_b23a6623f301abe9dc853f87ef4e1bdf, "r"); $_05f7bc393b3b384e419d26b776dba0e3 = $_e3f4c2e7eaad8039fc9ce37042c9f3ff; $_5f0fd6ac28489d03efe18b6fa3aee786 = -2; $_76af3710e1ceb47d011732e56fbe19b3 = false; $_8aa736d0e8a6cc0edb16cd51edab1060 = array(); while ($_05f7bc393b3b384e419d26b776dba0e3 > 0) { $_2e0412b283cca45495cf1aba6732c382 = " "; while ($_2e0412b283cca45495cf1aba6732c382 != "\n") { if(fseek($_699f8e535a4b8ec5e03224497c24306e, $_5f0fd6ac28489d03efe18b6fa3aee786, SEEK_END) == -1) { $_76af3710e1ceb47d011732e56fbe19b3 = true; break; } $_2e0412b283cca45495cf1aba6732c382 = fgetc($_699f8e535a4b8ec5e03224497c24306e); $_5f0fd6ac28489d03efe18b6fa3aee786 --; } $_05f7bc393b3b384e419d26b776dba0e3 --; if ($_76af3710e1ceb47d011732e56fbe19b3) { rewind($_699f8e535a4b8ec5e03224497c24306e); } $_8aa736d0e8a6cc0edb16cd51edab1060[$_e3f4c2e7eaad8039fc9ce37042c9f3ff-$_05f7bc393b3b384e419d26b776dba0e3-1] = fgets($_699f8e535a4b8ec5e03224497c24306e); if ($_76af3710e1ceb47d011732e56fbe19b3) break; } fclose ($_699f8e535a4b8ec5e03224497c24306e); return array_reverse($_8aa736d0e8a6cc0edb16cd51edab1060); } }
?>

