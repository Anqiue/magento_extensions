<?php
/**
 * @category   Php4u
 * @package    Php4u_BlastLuceneSearch
 * @author     Marcin Szterling <marcin@php4u.co.uk>
 * @copyright  Php4u Marcin Szterling (c) 2011
 * @license http://php4u.co.uk/licence/
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 * Any form of ditribution, sell, transfer forbidden, reverse engineering forbidden - see licence above
 *
 * Code was obfusacted due to previous licence violations
 */
class Php4u_BlastLuceneSearch_Model_Observer extends Mage_Core_Model_Abstract { const XML_PATH_GENERATION_ENABLED = 'php4u/generate/enabled'; const XML_PATH_CRON_EXPR = 'crontab/jobs/blastlucenesearch_generate/schedule/cron_expr'; const XML_PATH_ERROR_TEMPLATE = 'php4u/generate/error_email_template'; const XML_PATH_ERROR_IDENTITY = 'php4u/generate/error_email_identity'; const XML_PATH_ERROR_RECIPIENT = 'php4u/generate/error_email'; public static function crontab($_8f03a8a414003d19a2a6c4c77b4b4e7b) { Mage::getSingleton('blastlucenesearch/blastlucenesearch')->optimizeIndexForAllStores(); } public static function scheduledGenerateIndex($_8f03a8a414003d19a2a6c4c77b4b4e7b) { Mage::getSingleton('blastlucenesearch/blastlucenesearch')->log("Cron Started"); if (!Mage::getStoreConfigFlag(self::XML_PATH_GENERATION_ENABLED)) { return; } try { Mage::getSingleton('blastlucenesearch/lucene')->rebuildIndex(); Mage::getSingleton('blastlucenesearch/blastlucenesearch')->log("Cron Ended"); } catch (Mage_Core_Exception $_519118287e3dd55482dd019e4fa23f1f) { $_4bdfa4b245ff6273deda0a3a1b2b053d[] = $_519118287e3dd55482dd019e4fa23f1f->getMessage(); Mage::getSingleton('blastlucenesearch/blastlucenesearch')->log("Cron Error"); } catch (Exception $_519118287e3dd55482dd019e4fa23f1f) { $_4bdfa4b245ff6273deda0a3a1b2b053d[] = $_519118287e3dd55482dd019e4fa23f1f->getMessage(); Mage::getSingleton('blastlucenesearch/blastlucenesearch')->log("Cron Error"); } if ($_4bdfa4b245ff6273deda0a3a1b2b053d && Mage::getStoreConfig(self::XML_PATH_ERROR_RECIPIENT)) { $_c998c0bdf3aff2d6c2965aa69a4dadb8 = Mage::getSingleton('core/translate'); $_c998c0bdf3aff2d6c2965aa69a4dadb8->setTranslateInline(false); $_42997154cc7bcaa8f2d1c019552d16a0 = Mage::getModel('core/email_template'); $_42997154cc7bcaa8f2d1c019552d16a0->setDesignConfig(array('area' => 'backend')) ->sendTransactional( Mage::getStoreConfig(self::XML_PATH_ERROR_TEMPLATE), Mage::getStoreConfig(self::XML_PATH_ERROR_IDENTITY), Mage::getStoreConfig(self::XML_PATH_ERROR_RECIPIENT), null, array('warnings' => join("\n", $_4bdfa4b245ff6273deda0a3a1b2b053d)) ); $_c998c0bdf3aff2d6c2965aa69a4dadb8->setTranslateInline(true); } } public function isMagentoVerLess14() { return (version_compare(Mage::getVersion(), '1.4.1.1') < 0); } protected function _getFulltextModel() { return Mage::getSingleton('blastlucenesearch/lucene'); } public function refreshProductIndex(Varien_Event_Observer $_5cc2cbb64c4784fc8013eac1e4194f9a) { if ($this->isMagentoVerLess14() == TRUE) { Mage::getSingleton('blastlucenesearch/blastlucenesearch')->log("[OBSERVER] refreshProductIndex"); $_4893dada75269923341493057a1fad51 = $_5cc2cbb64c4784fc8013eac1e4194f9a->getEvent()->getProduct(); Mage::getSingleton('blastlucenesearch/blastlucenesearch')->markAsIndexRequired($_4893dada75269923341493057a1fad51->getId()); $this->_getFulltextModel() ->rebuildIndex(null, $_4893dada75269923341493057a1fad51->getId()) ->resetSearchResults(); } return $this; } public function cleanProductIndex(Varien_Event_Observer $_5cc2cbb64c4784fc8013eac1e4194f9a) { if ($this->isMagentoVerLess14() == TRUE) { Mage::getSingleton('blastlucenesearch/blastlucenesearch')->log("[OBSERVER] cleanProductIndex"); $_4893dada75269923341493057a1fad51 = $_5cc2cbb64c4784fc8013eac1e4194f9a->getEvent()->getProduct(); Mage::getSingleton('blastlucenesearch/blastlucenesearch')->markAsIndexRequired($_4893dada75269923341493057a1fad51->getId()); $this->_getFulltextModel() ->cleanIndex(null, $_4893dada75269923341493057a1fad51->getId()) ->resetSearchResults(); } return $this; } public function eavAttributeChange(Varien_Event_Observer $_5cc2cbb64c4784fc8013eac1e4194f9a) { Mage::getSingleton('blastlucenesearch/blastlucenesearch')->log("[OBSERVER] eavAttributeChange"); $_7ee28c5e38d544a5914b613b82f86a4e = $_5cc2cbb64c4784fc8013eac1e4194f9a->getEvent()->getAttribute(); $_762c42ee537c149c1b61714a2c3cf78f = Mage::getSingleton('eav/config')->getEntityType('catalog_product'); if ($_7ee28c5e38d544a5914b613b82f86a4e->getEntityTypeId() != $_762c42ee537c149c1b61714a2c3cf78f->getId()) { return $this; } $_e7db8b5bbc830430ab305899dc5ae058 = $_5cc2cbb64c4784fc8013eac1e4194f9a->getEventName() == 'eav_entity_attribute_delete_after'; if (!$_e7db8b5bbc830430ab305899dc5ae058 && !$_7ee28c5e38d544a5914b613b82f86a4e->dataHasChangedFor('is_searchable')) { return $this; } $_51b6d157c1c5fa6ff6a58fb29586c85f = false; if ($_e7db8b5bbc830430ab305899dc5ae058) { if ($_7ee28c5e38d544a5914b613b82f86a4e->getIsSearchable()) { $_51b6d157c1c5fa6ff6a58fb29586c85f = true; } } elseif ($_7ee28c5e38d544a5914b613b82f86a4e->dataHasChangedFor('is_searchable')) { $_51b6d157c1c5fa6ff6a58fb29586c85f = true; } if ($_51b6d157c1c5fa6ff6a58fb29586c85f) { $_5a1c7eb99d870ceefd8a2f9359e4e835 = Mage::getSingleton('adminhtml/url')->getUrl('adminhtml/system_cache'); Mage::getSingleton('adminhtml/session')->addNotice( Mage::helper('catalogsearch')->__('Attribute setting change related with Search Index. Please run <a href="%s">Rebuild Search Index and Lucene Search Index</a> process', $_5a1c7eb99d870ceefd8a2f9359e4e835) ); } return $this; } public function refreshIndexAfterImport() { if ($this->isMagentoVerLess14() == TRUE) { Mage::getSingleton('blastlucenesearch/blastlucenesearch')->log("[OBSERVER] refreshIndexAfterImport"); $this->_getFulltextModel() ->rebuildIndex(); } return $this; } public function refreshStoreIndex(Varien_Event_Observer $_5cc2cbb64c4784fc8013eac1e4194f9a) { if ($this->isMagentoVerLess14() == TRUE) { Mage::getSingleton('blastlucenesearch/blastlucenesearch')->log("[OBSERVER] refreshStoreIndex"); $_24297091fae06ab2d6350787ac1de982 = $_5cc2cbb64c4784fc8013eac1e4194f9a->getEvent()->getStore()->getId(); $this->_getFulltextModel()->rebuildIndex($_24297091fae06ab2d6350787ac1de982); } return $this; } public function catalogProductWebsiteUpdate(Varien_Event_Observer $_5cc2cbb64c4784fc8013eac1e4194f9a) { if ($this->isMagentoVerLess14() == TRUE) { Mage::getSingleton('blastlucenesearch/blastlucenesearch')->log("[OBSERVER] catalogProductWebsiteUpdate"); $_8d29ebdcb11f545b7170425c981c1571 = $_5cc2cbb64c4784fc8013eac1e4194f9a->getEvent()->getWebsiteIds(); $_42a646054edf7a70c82f96df7a895b92 = $_5cc2cbb64c4784fc8013eac1e4194f9a->getEvent()->getProductIds(); $_56c960d294417c82e4978124da7c60f3 = $_5cc2cbb64c4784fc8013eac1e4194f9a->getEvent()->getAction(); foreach ($_8d29ebdcb11f545b7170425c981c1571 as $_2584bf087659163ae078be9819e6d276) { foreach (Mage::app()->getWebsite($_2584bf087659163ae078be9819e6d276)->getStoreIds() as $_24297091fae06ab2d6350787ac1de982) { if ($_56c960d294417c82e4978124da7c60f3 == 'remove') { $this->_getFulltextModel() ->cleanIndex($_24297091fae06ab2d6350787ac1de982, $_42a646054edf7a70c82f96df7a895b92) ->resetSearchResults(); } elseif ($_56c960d294417c82e4978124da7c60f3 == 'add') { $this->_getFulltextModel() ->rebuildIndex($_24297091fae06ab2d6350787ac1de982, $_42a646054edf7a70c82f96df7a895b92) ->resetSearchResults(); } } } } return $this; } public function cleanStoreIndex(Varien_Event_Observer $_5cc2cbb64c4784fc8013eac1e4194f9a) { if ($this->isMagentoVerLess14() == TRUE) { Mage::getSingleton('blastlucenesearch/blastlucenesearch')->log("[OBSERVER] cleanStoreIndex"); $_5f969557be0d48e70acf8a7850546deb = $_5cc2cbb64c4784fc8013eac1e4194f9a->getEvent()->getStore(); $this->_getFulltextModel() ->cleanIndex($_5f969557be0d48e70acf8a7850546deb->getId()); } return $this; } public function onConfigChange(Varien_Event_Observer $_5cc2cbb64c4784fc8013eac1e4194f9a) { Mage::getSingleton('blastlucenesearch/blastlucenesearch')->log("[CONFIG CHANGE] Configuration changed so clearing search results."); Mage::getSingleton('catalogsearch/mysql4_fulltext')->resetSearchResults(); Mage::getModel('blastlucenesearch/blastlucenesearch')->isLicValid(); } }
?>
