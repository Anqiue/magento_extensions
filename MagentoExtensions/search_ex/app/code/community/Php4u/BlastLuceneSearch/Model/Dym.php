<?php
/**
 * @category   Php4u
 * @package    Php4u_BlastLuceneSearch
 * @author     Marcin Szterling <marcin@php4u.co.uk>
 * @copyright  Php4u Marcin Szterling (c) 2011
 * @license http://php4u.co.uk/licence/
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 * Any form of ditribution, sell, transfer forbidden, reverse engineering forbidden - see licence above
 *
 * Code was obfusacted due to previous licence violations
 */
class Php4u_BlastLuceneSearch_Model_Dym extends Mage_Core_Model_Abstract { protected $_index; protected $_storeId; static $_logname = 'blastlucenesearch-dym.log'; const CACHE_TAG = 'php4u_lucene_dym_data_'; const CACHE_LIFETIME = 86400; public function __construct($_fc68e66b735123bf8cb94c720e71869c = array()) { Zend_Search_Lucene_Analysis_Analyzer::setDefault(new Zend_Search_Lucene_Analysis_Analyzer_Common_Utf8Num_CaseInsensitive()); Zend_Search_Lucene_Search_QueryParser::setDefaultOperator(Zend_Search_Lucene_Search_QueryParser::B_OR); Zend_Search_Lucene_Storage_Directory_Filesystem::setDefaultFilePermissions(0777); } public function setStoreId($_a8da9bdc20e4f04d46e10add4bc176b6) { $this->_storeId = intval($_a8da9bdc20e4f04d46e10add4bc176b6); $this->_index = null; return $this; } public function getStoreId() { if (empty($this->_storeId)) { $this->setStoreId(Mage::app()->getStore()->getId()); } return $this->_storeId; } protected function _cache() { return Mage::getSingleton('core/cache'); } protected function _clearTags() { $this->_cache()->clean(self::CACHE_TAG); } protected function _generateCacheKey($_a2c0de17b0e03983b04a9dcdbebdbf4c) { return sha1($_a2c0de17b0e03983b04a9dcdbebdbf4c); } public function getIndexFolder($_0305bfe9fbb858b0a75dafb2dd0aa2bc=true) { if ($this->getStoreId() < 1) { $this->setStoreId(Mage::app()->getStore()->getStoreId()); } $_ad44aa1c8b8071e5f9d87890089246dd = Mage::getBaseDir('var').DS.'indexer'.DS.$this->getStoreId().'dym'.DS; if (!is_dir($_ad44aa1c8b8071e5f9d87890089246dd)) { mkdir($_ad44aa1c8b8071e5f9d87890089246dd, 0777, true); if (stripos(PHP_OS, 'win') === FALSE) { $_95796198f6205fac26cab36bd885800a = array( 'name' => 'apache', 'gecos' => 'apache' ); if (function_exists('posix_getpwuid') && function_exists('posix_geteuid')) { $_95796198f6205fac26cab36bd885800a = posix_getpwuid(posix_geteuid()); @chown($_ad44aa1c8b8071e5f9d87890089246dd, isset($_95796198f6205fac26cab36bd885800a['name']) ? $_95796198f6205fac26cab36bd885800a['name'] : get_current_user()); @chgrp($_ad44aa1c8b8071e5f9d87890089246dd, isset($_95796198f6205fac26cab36bd885800a['gecos']) ? $_95796198f6205fac26cab36bd885800a['gecos'] : get_current_user()); } } } return $_ad44aa1c8b8071e5f9d87890089246dd; } public function getSuggestions($_a2c0de17b0e03983b04a9dcdbebdbf4c) { $_19ecf2209ce8e8a7d476d5966cbb8dc1 = FALSE; $_73f3d071afa4770a00058bfe662d1e4d = ''; try { if (!Mage::getStoreConfigFlag('php4u/dym/enabled', $this->getStoreId())) { return false; } $_20e82380a72ce206513d660a33bbfdb3 = microtime(true); $_a5eb6bd33603fdd586545433b932340c = $this->_cache()->load($this->_generateCacheKey($_a2c0de17b0e03983b04a9dcdbebdbf4c)); if ($_a5eb6bd33603fdd586545433b932340c) { $_91a3b647e524b8514279c203443799f6 = microtime(true) - $_20e82380a72ce206513d660a33bbfdb3; self::log("Finding suggestion for '{$_a2c0de17b0e03983b04a9dcdbebdbf4c}' took {$_91a3b647e524b8514279c203443799f6}s (from cache)"); return $_a5eb6bd33603fdd586545433b932340c; } $_4091b1eeb6571949dfb2c50fde4cd688 = $this->_getMagentoSearchIndex(); $_7b711c92bc4bd99c2d24413abf0aa471 = Zend_Search_Lucene_Analysis_Analyzer::getDefault(); $_1082b7d349c7ddc14d3e85f20868eebc = $_7b711c92bc4bd99c2d24413abf0aa471->tokenize($_a2c0de17b0e03983b04a9dcdbebdbf4c, 'utf-8'); $_aea95f35301e62f0c9e93fb5f8caa5a2 = count($_1082b7d349c7ddc14d3e85f20868eebc); $_440052f8873034223a897fe287bdd451 = Mage::getStoreConfig('php4u/dym/query_words_limit', $this->getStoreId()); if ($_aea95f35301e62f0c9e93fb5f8caa5a2 > $_440052f8873034223a897fe287bdd451) { self::log("Query words limit reached ($_aea95f35301e62f0c9e93fb5f8caa5a2) - limit $_440052f8873034223a897fe287bdd451"); return ''; } $_701a9e881f9e0712df031ff46b21dd8a = 0; foreach ($_1082b7d349c7ddc14d3e85f20868eebc as $_eb060dbb9954e5c12ecb80baad0b19ec => $_9c7929eb3d44fec95476fc82dd134861) { $_6dd456098239c0550f422ce1a2ee63ec = $_9c7929eb3d44fec95476fc82dd134861->getTermText(); $_d3397b4f801448051489fb8783d00499 = ''; $_f5ec704d8072562cb80ebee9c1be2335 = array( 'start' => $_9c7929eb3d44fec95476fc82dd134861->getStartOffset(), 'end' => $_9c7929eb3d44fec95476fc82dd134861->getEndOffset(), ); $_926be9dd8be8ec8b7febb002f39d47e0 = $this->_calculateIdf($_4091b1eeb6571949dfb2c50fde4cd688, $_6dd456098239c0550f422ce1a2ee63ec); if (FALSE !== $_926be9dd8be8ec8b7febb002f39d47e0 && $_926be9dd8be8ec8b7febb002f39d47e0 < 1) { if ($_8d0b3d1e66234023967085736fef197b = $this->_buildNGramQuery($_6dd456098239c0550f422ce1a2ee63ec)) { $_6e2adf379ecdee3e15b8dadb92f6f1e3 = $this->getIndex()->find($_8d0b3d1e66234023967085736fef197b); $_1b25366a57262a9beb49674586bfd219 = (count($_6e2adf379ecdee3e15b8dadb92f6f1e3)) ? $this->getIndex()->getDocument($_6e2adf379ecdee3e15b8dadb92f6f1e3[0]->id)->getFieldValue('index_data') : FALSE; if (FALSE !== $_1b25366a57262a9beb49674586bfd219 && $_6dd456098239c0550f422ce1a2ee63ec != $_1b25366a57262a9beb49674586bfd219) { $_19ecf2209ce8e8a7d476d5966cbb8dc1 = TRUE; $_ca9d164444cbd995979f13226bf8ed96 = sprintf( '%s%s%s', substr($_a2c0de17b0e03983b04a9dcdbebdbf4c, 0, $_f5ec704d8072562cb80ebee9c1be2335['start']), $_1b25366a57262a9beb49674586bfd219, substr($_a2c0de17b0e03983b04a9dcdbebdbf4c, $_f5ec704d8072562cb80ebee9c1be2335['end']) ); $_9cacf3d69f090e1b9d80773cc323edba = ''; $_ad44aa1c8b8071e5f9d87890089246dd = sprintf($_9cacf3d69f090e1b9d80773cc323edba, $_ca9d164444cbd995979f13226bf8ed96); $_d3397b4f801448051489fb8783d00499 = $_1b25366a57262a9beb49674586bfd219; } } } else { } $_39a0e89f65c2107eb8539dad1bd1f98d = $_f5ec704d8072562cb80ebee9c1be2335['start'] - $_701a9e881f9e0712df031ff46b21dd8a; $_73f3d071afa4770a00058bfe662d1e4d .= substr($_a2c0de17b0e03983b04a9dcdbebdbf4c, $_701a9e881f9e0712df031ff46b21dd8a, $_39a0e89f65c2107eb8539dad1bd1f98d); if ($_d3397b4f801448051489fb8783d00499) { $_73f3d071afa4770a00058bfe662d1e4d .= $_d3397b4f801448051489fb8783d00499; } else { $_39a0e89f65c2107eb8539dad1bd1f98d = $_f5ec704d8072562cb80ebee9c1be2335['end'] - $_f5ec704d8072562cb80ebee9c1be2335['start']; $_73f3d071afa4770a00058bfe662d1e4d .= substr($_a2c0de17b0e03983b04a9dcdbebdbf4c, $_f5ec704d8072562cb80ebee9c1be2335['start'], $_39a0e89f65c2107eb8539dad1bd1f98d); } $_701a9e881f9e0712df031ff46b21dd8a = $_f5ec704d8072562cb80ebee9c1be2335['end']; if ($_eb060dbb9954e5c12ecb80baad0b19ec + 1 >= $_aea95f35301e62f0c9e93fb5f8caa5a2) { $_73f3d071afa4770a00058bfe662d1e4d .= substr($_a2c0de17b0e03983b04a9dcdbebdbf4c, $_701a9e881f9e0712df031ff46b21dd8a); } } if ($_19ecf2209ce8e8a7d476d5966cbb8dc1) { $this->_cache()->save($_73f3d071afa4770a00058bfe662d1e4d, $this->_generateCacheKey($_a2c0de17b0e03983b04a9dcdbebdbf4c), array(self::CACHE_TAG), self::CACHE_LIFETIME); self::log("Saved to cache"); } $_91a3b647e524b8514279c203443799f6 = microtime(true) - $_20e82380a72ce206513d660a33bbfdb3; self::log("Finding suggestion for '{$_a2c0de17b0e03983b04a9dcdbebdbf4c}' took {$_91a3b647e524b8514279c203443799f6}s"); } catch (Exception $_34671387cc3a95d251b2813010d0af0e) { self::log("Error: ".$_34671387cc3a95d251b2813010d0af0e->getMessage(), Zend_Log::ERR); } return ($_19ecf2209ce8e8a7d476d5966cbb8dc1) ? $_73f3d071afa4770a00058bfe662d1e4d : ''; } protected function _buildNGramQuery($_6dd456098239c0550f422ce1a2ee63ec) { $_8d0b3d1e66234023967085736fef197b = new Zend_Search_Lucene_Search_Query_Boolean(); $_36fd36d1a52b5223a0421f0ddc37e2a9 = array(); $_36fd36d1a52b5223a0421f0ddc37e2a9 += $this->_ngramParse($_6dd456098239c0550f422ce1a2ee63ec, 2); $_36fd36d1a52b5223a0421f0ddc37e2a9 += $this->_ngramParse($_6dd456098239c0550f422ce1a2ee63ec, 3); $_36fd36d1a52b5223a0421f0ddc37e2a9 += $this->_ngramParse($_6dd456098239c0550f422ce1a2ee63ec, 4); foreach ($_36fd36d1a52b5223a0421f0ddc37e2a9 as $_620752b94b987e3da9c048bd57a4782b => $_ca2435f25ac29033064152b3ca7cba63) { if (!empty($_ca2435f25ac29033064152b3ca7cba63)) { $_c18b73a94c7b161b35db8d9b3ac839de = explode(' ', $_ca2435f25ac29033064152b3ca7cba63); foreach ($_c18b73a94c7b161b35db8d9b3ac839de as $_bb1850648faef61905b08c1dc1f00c28) { $_eb93fd4c6b4997f9dd96a9432cf67349 = new Zend_Search_Lucene_Index_Term($_bb1850648faef61905b08c1dc1f00c28, $_620752b94b987e3da9c048bd57a4782b); $_9e021c755004e51084d4a9670f96f22a = new Zend_Search_Lucene_Search_Query_Term($_eb93fd4c6b4997f9dd96a9432cf67349); if (0 === strpos($_620752b94b987e3da9c048bd57a4782b, 'start')) { $_9e021c755004e51084d4a9670f96f22a->setBoost(2); } $_8d0b3d1e66234023967085736fef197b->addSubquery($_9e021c755004e51084d4a9670f96f22a, NULL); } } } return $_8d0b3d1e66234023967085736fef197b; } public function getIndex($_0305bfe9fbb858b0a75dafb2dd0aa2bc=true) { if (!$this->_index) { try { $this->_index = Zend_Search_Lucene::open($this->getIndexFolder($_0305bfe9fbb858b0a75dafb2dd0aa2bc)); } catch (Zend_Search_Lucene_Exception $_f13c7823c10debeb0c9a46a87acd4ac5) { $this->_index = Zend_Search_Lucene::create($this->getIndexFolder($_0305bfe9fbb858b0a75dafb2dd0aa2bc)); } if (!$this->_index) { throw new Exception("Problem creating Lucene index in ".$this->getIndexFolder()); } } return $this->_index; } private function _getMagentoSearchIndex() { return Mage::getModel('blastlucenesearch/blastlucenesearch') ->setStoreId($this->getStoreId()) ->getIndex(); } public function indexDym() { try { if (!Mage::getStoreConfigFlag('php4u/dym/enabled', $this->getStoreId())) { self::log("DYM is off", Zend_Log::NOTICE); return false; } $_875652b6355041d5d97099d83728eed2 = $this->_getMagentoSearchIndex(); $_baa11a07b9dd3f63430fc232c14fd457 = $this->getIndexTerms($_875652b6355041d5d97099d83728eed2, 'index_data'); $_0ec76778ef6474c9ced6d5693f5df64d = $this->getIndexTerms($this->getIndex(), 'index_data'); $_0621677e9476b4b60978c2911ee5fefd = array_diff($_baa11a07b9dd3f63430fc232c14fd457, $_0ec76778ef6474c9ced6d5693f5df64d); $_2542f0299d61f87be82ce75ff5c2bc07 = array_diff($_0ec76778ef6474c9ced6d5693f5df64d, $_baa11a07b9dd3f63430fc232c14fd457); self::log("A". count($_0621677e9476b4b60978c2911ee5fefd)); self::log("R". count($_2542f0299d61f87be82ce75ff5c2bc07)); $_15c03b877aaca43b93ddae835ad256df = Mage::getStoreConfig('php4u/dym/tags_limiter', $this->getStoreId()); if ($_15c03b877aaca43b93ddae835ad256df > 0) { if (count($_0621677e9476b4b60978c2911ee5fefd) > $_15c03b877aaca43b93ddae835ad256df) { self::log("Current number of tags is greater than limit [$_15c03b877aaca43b93ddae835ad256df]", Zend_Log::WARN); return false; } } $_81a6a1417d9c37d47f2fac2761d307ca=0; $_cf66c49925a9b87d4dfeb2fa68aa18b2 = 1000; foreach ($_0621677e9476b4b60978c2911ee5fefd as $_6dd456098239c0550f422ce1a2ee63ec) { $_81a6a1417d9c37d47f2fac2761d307ca++; $_cf66c49925a9b87d4dfeb2fa68aa18b2--; $this->_addToIndex( $this->_prepareDoc($_6dd456098239c0550f422ce1a2ee63ec) ); if ($_cf66c49925a9b87d4dfeb2fa68aa18b2 < 1) { self::log("Adding $_81a6a1417d9c37d47f2fac2761d307ca / ". count($_0621677e9476b4b60978c2911ee5fefd). " (".round($_81a6a1417d9c37d47f2fac2761d307ca/count($_0621677e9476b4b60978c2911ee5fefd)*100,2)."%)"); $this->getIndex()->commit(); $this->optimizeIndex(); $_cf66c49925a9b87d4dfeb2fa68aa18b2 = 1000; } } $_81a6a1417d9c37d47f2fac2761d307ca=0; foreach ($_2542f0299d61f87be82ce75ff5c2bc07 as $_6dd456098239c0550f422ce1a2ee63ec) { self::log("Removing $_81a6a1417d9c37d47f2fac2761d307ca / ". count($_2542f0299d61f87be82ce75ff5c2bc07). " (".round($_81a6a1417d9c37d47f2fac2761d307ca/count($_2542f0299d61f87be82ce75ff5c2bc07)*100,2)."%)"); $_81a6a1417d9c37d47f2fac2761d307ca++; $this->_removeWordFromIndex( $_6dd456098239c0550f422ce1a2ee63ec ); } $this->getIndex()->commit(); $this->optimizeIndex(); $this->_clearTags(); } catch (Exception $_34671387cc3a95d251b2813010d0af0e) { self::log("Error: ".$_34671387cc3a95d251b2813010d0af0e->getMessage(), Zend_Log::ERR); } return $this; } private function _removeWordFromIndex($_6dd456098239c0550f422ce1a2ee63ec) { $_eb93fd4c6b4997f9dd96a9432cf67349 = new Zend_Search_Lucene_Index_Term($_6dd456098239c0550f422ce1a2ee63ec, 'index_data'); $_520278c2468cdc92d39c98913122cf6c = $this->getIndex()->termDocs($_eb93fd4c6b4997f9dd96a9432cf67349); foreach ($_520278c2468cdc92d39c98913122cf6c as $_88966ab0eaafd5f8ee0a220f711bdb4c) { $this->getIndex()->delete($_88966ab0eaafd5f8ee0a220f711bdb4c); } $this->getIndex()->commit(); return $this; } protected function _prepareDoc($_6dd456098239c0550f422ce1a2ee63ec) { $_d7d3db8d0311f4587ddc67cea9f16606 = new Zend_Search_Lucene_Document(); $_36fd36d1a52b5223a0421f0ddc37e2a9 = array('index_data' => (string)$_6dd456098239c0550f422ce1a2ee63ec); $_36fd36d1a52b5223a0421f0ddc37e2a9 += $this->_ngramParse($_6dd456098239c0550f422ce1a2ee63ec, 2); $_36fd36d1a52b5223a0421f0ddc37e2a9 += $this->_ngramParse($_6dd456098239c0550f422ce1a2ee63ec, 3); $_36fd36d1a52b5223a0421f0ddc37e2a9 += $this->_ngramParse($_6dd456098239c0550f422ce1a2ee63ec, 4); foreach ($_36fd36d1a52b5223a0421f0ddc37e2a9 as $_eb060dbb9954e5c12ecb80baad0b19ec => $_620752b94b987e3da9c048bd57a4782b) { if ($_eb060dbb9954e5c12ecb80baad0b19ec == 'index_data') { $_d7d3db8d0311f4587ddc67cea9f16606->addField(Zend_Search_Lucene_Field::keyword($_eb060dbb9954e5c12ecb80baad0b19ec, $_620752b94b987e3da9c048bd57a4782b, 'utf-8')); } else { $_d7d3db8d0311f4587ddc67cea9f16606->addField(Zend_Search_Lucene_Field::unStored($_eb060dbb9954e5c12ecb80baad0b19ec, $_620752b94b987e3da9c048bd57a4782b, 'utf-8')); } } return $_d7d3db8d0311f4587ddc67cea9f16606; } protected function _ngramParse($_6dd456098239c0550f422ce1a2ee63ec, $_fb93654aab76b8c0f71d8f7ef4be6dd4) { $_6dd456098239c0550f422ce1a2ee63ec = strval($_6dd456098239c0550f422ce1a2ee63ec); $_fb93654aab76b8c0f71d8f7ef4be6dd4 = intval($_fb93654aab76b8c0f71d8f7ef4be6dd4); $_e67ff5786fc7ae885d3ea67f57ca9bf5 = array( 'start'. $_fb93654aab76b8c0f71d8f7ef4be6dd4 => '', 'gram'. $_fb93654aab76b8c0f71d8f7ef4be6dd4 => '', 'end'. $_fb93654aab76b8c0f71d8f7ef4be6dd4 => '', ); $_d449ba0531d1bdc992b0c435ee970544 = strlen($_6dd456098239c0550f422ce1a2ee63ec); if ($_d449ba0531d1bdc992b0c435ee970544 > $_fb93654aab76b8c0f71d8f7ef4be6dd4 && $_fb93654aab76b8c0f71d8f7ef4be6dd4 > 0) { $_4d2ccd9322fe30133f06a2b2401b86dd = $_d449ba0531d1bdc992b0c435ee970544 - $_fb93654aab76b8c0f71d8f7ef4be6dd4; $_e67ff5786fc7ae885d3ea67f57ca9bf5['start'. $_fb93654aab76b8c0f71d8f7ef4be6dd4] = substr($_6dd456098239c0550f422ce1a2ee63ec, 0, $_fb93654aab76b8c0f71d8f7ef4be6dd4); $_e67ff5786fc7ae885d3ea67f57ca9bf5['end'. $_fb93654aab76b8c0f71d8f7ef4be6dd4] = substr($_6dd456098239c0550f422ce1a2ee63ec, $_4d2ccd9322fe30133f06a2b2401b86dd, $_fb93654aab76b8c0f71d8f7ef4be6dd4); $_e67ff5786fc7ae885d3ea67f57ca9bf5['gram'. $_fb93654aab76b8c0f71d8f7ef4be6dd4] = array(); for ($_365117f84c512ef5543f68b3a2fab707 = 1; $_365117f84c512ef5543f68b3a2fab707 < $_4d2ccd9322fe30133f06a2b2401b86dd; $_365117f84c512ef5543f68b3a2fab707++) { $_e67ff5786fc7ae885d3ea67f57ca9bf5['gram'. $_fb93654aab76b8c0f71d8f7ef4be6dd4][] = substr($_6dd456098239c0550f422ce1a2ee63ec, $_365117f84c512ef5543f68b3a2fab707, $_fb93654aab76b8c0f71d8f7ef4be6dd4); } $_e67ff5786fc7ae885d3ea67f57ca9bf5['gram'. $_fb93654aab76b8c0f71d8f7ef4be6dd4] = join(' ', $_e67ff5786fc7ae885d3ea67f57ca9bf5['gram'. $_fb93654aab76b8c0f71d8f7ef4be6dd4]); } return $_e67ff5786fc7ae885d3ea67f57ca9bf5; } protected function _calculateIdf(Zend_Search_Lucene_Interface $_4091b1eeb6571949dfb2c50fde4cd688, $_6dd456098239c0550f422ce1a2ee63ec) { $_bf4e467e643624d779af9fa934b21d6a = 0; $_89421d146d564d0c0495ffb3f665ec36 = $_4091b1eeb6571949dfb2c50fde4cd688->getSimilarity(); $_eb93fd4c6b4997f9dd96a9432cf67349 = new Zend_Search_Lucene_Index_Term($_6dd456098239c0550f422ce1a2ee63ec); $_bf4e467e643624d779af9fa934b21d6a += $this->_getTermfreq($_4091b1eeb6571949dfb2c50fde4cd688, $_6dd456098239c0550f422ce1a2ee63ec, 'index_data'); return $_89421d146d564d0c0495ffb3f665ec36->tf($_bf4e467e643624d779af9fa934b21d6a) * $_89421d146d564d0c0495ffb3f665ec36->idf($_eb93fd4c6b4997f9dd96a9432cf67349, $_4091b1eeb6571949dfb2c50fde4cd688); } protected function _getTermfreq(Zend_Search_Lucene_Interface $_4091b1eeb6571949dfb2c50fde4cd688, $_eb93fd4c6b4997f9dd96a9432cf67349, $_620752b94b987e3da9c048bd57a4782b = NULL) { $_2a4c8a6fdc1aa911f654d1ae2ad41ab8 = $this->_getTermfreqs($_4091b1eeb6571949dfb2c50fde4cd688, $_eb93fd4c6b4997f9dd96a9432cf67349, $_620752b94b987e3da9c048bd57a4782b); $_ad8900fc81d07485a00ce861dfac80ff = 0; foreach ($_2a4c8a6fdc1aa911f654d1ae2ad41ab8 as $_128f13b7659d803a9d2b0a7b5031c555 => $_9e20dde30187cdbebc3c4ecc8ce5858a) { $_ad8900fc81d07485a00ce861dfac80ff += $_9e20dde30187cdbebc3c4ecc8ce5858a; } return $_ad8900fc81d07485a00ce861dfac80ff; } protected function _getTermfreqs(Zend_Search_Lucene_Interface $_4091b1eeb6571949dfb2c50fde4cd688, $_eb93fd4c6b4997f9dd96a9432cf67349, $_620752b94b987e3da9c048bd57a4782b = NULL){ $_eb93fd4c6b4997f9dd96a9432cf67349 = new Zend_Search_Lucene_Index_Term(strtolower($_eb93fd4c6b4997f9dd96a9432cf67349), $_620752b94b987e3da9c048bd57a4782b); return $_4091b1eeb6571949dfb2c50fde4cd688->termFreqs($_eb93fd4c6b4997f9dd96a9432cf67349); } public function getIndexTerms(Zend_Search_Lucene_Interface $_4091b1eeb6571949dfb2c50fde4cd688, $_620752b94b987e3da9c048bd57a4782b = 'index_data_keyword') { $_fa3c7f5519604fce66eafcc084e00845 = $_4091b1eeb6571949dfb2c50fde4cd688->terms(); $_62278b892776e8fd50bd6fbd3f24a320 = array(); foreach ($_fa3c7f5519604fce66eafcc084e00845 as $_eb93fd4c6b4997f9dd96a9432cf67349) { if ($_eb93fd4c6b4997f9dd96a9432cf67349->field == $_620752b94b987e3da9c048bd57a4782b) { $_62278b892776e8fd50bd6fbd3f24a320[] = $_eb93fd4c6b4997f9dd96a9432cf67349->text; } } return array_unique($_62278b892776e8fd50bd6fbd3f24a320); } public function removeAll() { self::log("[REMOVEALL] Start"); for ($_365117f84c512ef5543f68b3a2fab707=0;$_365117f84c512ef5543f68b3a2fab707<$this->getIndex()->maxDoc();$_365117f84c512ef5543f68b3a2fab707++) { if (!$this->getIndex()->isDeleted($_365117f84c512ef5543f68b3a2fab707)) { $this->getIndex()->delete($_365117f84c512ef5543f68b3a2fab707); } } $this->getIndex()->commit(); $this->optimizeIndex(); self::log("[REMOVEALL] Done"); } public function optimizeIndex() { $_20e82380a72ce206513d660a33bbfdb3 = microtime(true); self::log("[OPTIMIZE] Store [".$this->getStoreId()."] Lucene index optimisation started"); $_8424cf3a7387ed9cc0b9a34a963ee8b4 = $this->getIndex()->optimize(); $_f70bc6316e0d344919a70c64b48ac3fa = microtime(true) - $_20e82380a72ce206513d660a33bbfdb3; self::log("[OPTIMIZE] [".$this->getStoreId()."] Lucene index optimisation done ($_f70bc6316e0d344919a70c64b48ac3fa secs). Max mem usage:".round(memory_get_peak_usage(true)/1024/1024,2)."Mb."); return $_8424cf3a7387ed9cc0b9a34a963ee8b4; } private function _addToIndex(Zend_Search_Lucene_Document $_d7d3db8d0311f4587ddc67cea9f16606) { return $this->getIndex()->addDocument($_d7d3db8d0311f4587ddc67cea9f16606); } public function cleanString($_a2c0de17b0e03983b04a9dcdbebdbf4c) { $_8980b8aa73a7de4b69aecfbac4ce9368 = explode(",","ç,æ,œ,á,é,í,ó,ú,à,è,ì,ò,ù,ä,ë,ï,ö,ü,ÿ,â,ê,î,ô,û,å,e,i,ø,u,ą,ę,ó,ł,ć,ś,ń,ź"); $_ca8587ba80676588d88b8bbf5931898d = explode(",","c,ae,oe,a,e,i,o,u,a,e,i,o,u,a,e,i,o,u,y,a,e,i,o,u,a,e,i,o,u,a,e,o,l,c,s,n,z"); $_a2c0de17b0e03983b04a9dcdbebdbf4c = str_replace($_8980b8aa73a7de4b69aecfbac4ce9368, $_ca8587ba80676588d88b8bbf5931898d, $_a2c0de17b0e03983b04a9dcdbebdbf4c); $_a2c0de17b0e03983b04a9dcdbebdbf4c = str_replace('|', " ", $_a2c0de17b0e03983b04a9dcdbebdbf4c); if (function_exists('iconv')) { $_a2c0de17b0e03983b04a9dcdbebdbf4c = @iconv("UTF-8", "UTF-8//IGNORE", $_a2c0de17b0e03983b04a9dcdbebdbf4c ); } else { $_a2c0de17b0e03983b04a9dcdbebdbf4c = @preg_replace("/[^a-zA-Z0-9\-\/\s]/", '', $_a2c0de17b0e03983b04a9dcdbebdbf4c); } if (!Mage::getStoreConfigFlag('php4u/php4u_group/php4u_lucene_utf8nonstandard', $this->getStoreId())) { $_a2c0de17b0e03983b04a9dcdbebdbf4c = @preg_replace("/[^a-zA-Z0-9\-\/\s]/", '', $_a2c0de17b0e03983b04a9dcdbebdbf4c); } $_a2c0de17b0e03983b04a9dcdbebdbf4c = preg_replace( '/\s+/', ' ', $_a2c0de17b0e03983b04a9dcdbebdbf4c ); $_a2c0de17b0e03983b04a9dcdbebdbf4c = trim($_a2c0de17b0e03983b04a9dcdbebdbf4c); return $_a2c0de17b0e03983b04a9dcdbebdbf4c; } public function log($_c6cc7bcf0d92fec0f78784d0d42b2cec, $_3e53ab0b15b47a1acb698910facbf788=null) { if (FALSE === Mage::getStoreConfigFlag('php4u/dym/log_enabled', $this->getStoreId())) { return; } if (isset($_SERVER['REMOTE_ADDR'])) { $_c6cc7bcf0d92fec0f78784d0d42b2cec = $_SERVER['REMOTE_ADDR']. "|".$_c6cc7bcf0d92fec0f78784d0d42b2cec; } $_c6cc7bcf0d92fec0f78784d0d42b2cec = 'DYM|'.$_c6cc7bcf0d92fec0f78784d0d42b2cec; Mage::log($_c6cc7bcf0d92fec0f78784d0d42b2cec, $_3e53ab0b15b47a1acb698910facbf788, self::$_logname); } }
?>
