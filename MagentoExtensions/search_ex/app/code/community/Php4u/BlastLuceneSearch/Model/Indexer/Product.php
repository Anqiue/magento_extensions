<?php
/**
 * @category   Php4u
 * @package    Php4u_BlastLuceneSearch
 * @author     Marcin Szterling <marcin@php4u.co.uk>
 * @copyright  Php4u Marcin Szterling (c) 2011
 * @license http://php4u.co.uk/licence/
 * THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
 * IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
 * FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE
 * AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
 * LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,
 * OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN
 * THE SOFTWARE.
 * Any form of ditribution, sell, transfer forbidden, reverse engineering forbidden - see licence above
 *
 * Code was obfusacted due to previous licence violations
 */
class Php4u_BlastLuceneSearch_Model_Indexer_Product extends Mage_Index_Model_Indexer_Abstract { protected $_relatedConfigSettings = array( Mage_CatalogSearch_Model_Fulltext::XML_PATH_CATALOG_SEARCH_TYPE ); protected $_matchedEntities = array( Mage_Catalog_Model_Product::ENTITY => array( Mage_Index_Model_Event::TYPE_SAVE, Mage_Index_Model_Event::TYPE_MASS_ACTION, Mage_Index_Model_Event::TYPE_DELETE ), Mage_Catalog_Model_Resource_Eav_Attribute::ENTITY => array( Mage_Index_Model_Event::TYPE_SAVE, Mage_Index_Model_Event::TYPE_DELETE, ), Mage_Core_Model_Store::ENTITY => array( Mage_Index_Model_Event::TYPE_SAVE, Mage_Index_Model_Event::TYPE_DELETE ), Mage_Core_Model_Store_Group::ENTITY => array( Mage_Index_Model_Event::TYPE_SAVE ), Mage_Core_Model_Config_Data::ENTITY => array( Mage_Index_Model_Event::TYPE_SAVE ), Mage_Catalog_Model_Convert_Adapter_Product::ENTITY => array( Mage_Index_Model_Event::TYPE_SAVE ), Mage_Catalog_Model_Category::ENTITY => array( Mage_Index_Model_Event::TYPE_SAVE ) ); protected function _getResource() { return Mage::getResourceSingleton('catalogsearch/indexer_fulltext'); } public function getName() { return Mage::helper('php4u')->__('Lucene Search Index'); } public function getDescription() { return Mage::helper('php4u')->__('Rebuild Apache Lucene product search index (new or all - check settings)'); } public function matchEvent(Mage_Index_Model_Event $_1b409d59e2b5e86c40205680bc8dc6e9) { $_d2c2a0552c85ff3aa1a15cb39fdd1d58 = $_1b409d59e2b5e86c40205680bc8dc6e9->getNewData(); $_72d1372cc418a4b4c8fe81443ae89ec1 = 'lucene_catalogsearch_fulltext_match_result'; if (isset($_d2c2a0552c85ff3aa1a15cb39fdd1d58[$_72d1372cc418a4b4c8fe81443ae89ec1])) { return $_d2c2a0552c85ff3aa1a15cb39fdd1d58[$_72d1372cc418a4b4c8fe81443ae89ec1]; } $_1479cb48fbe6f68e5deed315ecfb34ea = null; $_021fe386de66e83dd38d72d40d96691d = $_1b409d59e2b5e86c40205680bc8dc6e9->getEntity(); if ($_021fe386de66e83dd38d72d40d96691d == Mage_Catalog_Model_Resource_Eav_Attribute::ENTITY) { $_26ef8c299e1081ca5f251a7628d4c00a = $_1b409d59e2b5e86c40205680bc8dc6e9->getDataObject(); if ($_1b409d59e2b5e86c40205680bc8dc6e9->getType() == Mage_Index_Model_Event::TYPE_SAVE) { $_1479cb48fbe6f68e5deed315ecfb34ea = $_26ef8c299e1081ca5f251a7628d4c00a->dataHasChangedFor('is_searchable'); } else if ($_1b409d59e2b5e86c40205680bc8dc6e9->getType() == Mage_Index_Model_Event::TYPE_DELETE) { $_1479cb48fbe6f68e5deed315ecfb34ea = $_26ef8c299e1081ca5f251a7628d4c00a->getIsSearchable(); } else { $_1479cb48fbe6f68e5deed315ecfb34ea = false; } } else if ($_021fe386de66e83dd38d72d40d96691d == Mage_Core_Model_Store::ENTITY) { if ($_1b409d59e2b5e86c40205680bc8dc6e9->getType() == Mage_Index_Model_Event::TYPE_DELETE) { $_1479cb48fbe6f68e5deed315ecfb34ea = true; } else { $_bd2eabc3822579ef4ca343130dcef5c2 = $_1b409d59e2b5e86c40205680bc8dc6e9->getDataObject(); if ($_bd2eabc3822579ef4ca343130dcef5c2->isObjectNew()) { $_1479cb48fbe6f68e5deed315ecfb34ea = true; } else { $_1479cb48fbe6f68e5deed315ecfb34ea = false; } } } else if ($_021fe386de66e83dd38d72d40d96691d == Mage_Core_Model_Store_Group::ENTITY) { $_c14a7e6e94cf29f682081e30058be38e = $_1b409d59e2b5e86c40205680bc8dc6e9->getDataObject(); if ($_c14a7e6e94cf29f682081e30058be38e->dataHasChangedFor('website_id')) { $_1479cb48fbe6f68e5deed315ecfb34ea = true; } else { $_1479cb48fbe6f68e5deed315ecfb34ea = false; } } else if ($_021fe386de66e83dd38d72d40d96691d == Mage_Core_Model_Config_Data::ENTITY) { $_d2c2a0552c85ff3aa1a15cb39fdd1d58 = $_1b409d59e2b5e86c40205680bc8dc6e9->getDataObject(); if (in_array($_d2c2a0552c85ff3aa1a15cb39fdd1d58->getPath(), $this->_relatedConfigSettings)) { $_1479cb48fbe6f68e5deed315ecfb34ea = $_d2c2a0552c85ff3aa1a15cb39fdd1d58->isValueChanged(); } else { $_1479cb48fbe6f68e5deed315ecfb34ea = false; } } else { $_1479cb48fbe6f68e5deed315ecfb34ea = parent::matchEvent($_1b409d59e2b5e86c40205680bc8dc6e9); } $_1b409d59e2b5e86c40205680bc8dc6e9->addNewData($_72d1372cc418a4b4c8fe81443ae89ec1, $_1479cb48fbe6f68e5deed315ecfb34ea); return $_1479cb48fbe6f68e5deed315ecfb34ea; } protected function _registerEvent(Mage_Index_Model_Event $_1b409d59e2b5e86c40205680bc8dc6e9) { switch ($_1b409d59e2b5e86c40205680bc8dc6e9->getEntity()) { case Mage_Catalog_Model_Product::ENTITY: $this->_registerCatalogProductEvent($_1b409d59e2b5e86c40205680bc8dc6e9); break; case Mage_Catalog_Model_Convert_Adapter_Product::ENTITY: $_1b409d59e2b5e86c40205680bc8dc6e9->addNewData('lucene_catalogsearch_fulltext_reindex_all', true); break; case Mage_Core_Model_Config_Data::ENTITY: case Mage_Core_Model_Store::ENTITY: case Mage_Catalog_Model_Resource_Eav_Attribute::ENTITY: case Mage_Core_Model_Store_Group::ENTITY: $_1b409d59e2b5e86c40205680bc8dc6e9->addNewData('lucene_catalogsearch_fulltext_skip_call_event_handler', true); $_1ade115fef9de25f75f8577d074a9ad7 = $_1b409d59e2b5e86c40205680bc8dc6e9->getProcess(); $_1ade115fef9de25f75f8577d074a9ad7->changeStatus(Mage_Index_Model_Process::STATUS_REQUIRE_REINDEX); break; } } protected function _registerCatalogProductEvent(Mage_Index_Model_Event $_1b409d59e2b5e86c40205680bc8dc6e9) { switch ($_1b409d59e2b5e86c40205680bc8dc6e9->getType()) { case Mage_Index_Model_Event::TYPE_SAVE: $_34f17fe369130a79e573376dcc7c661e = $_1b409d59e2b5e86c40205680bc8dc6e9->getDataObject(); $_1b409d59e2b5e86c40205680bc8dc6e9->addNewData('lucene_catalogsearch_update_product_id', $_34f17fe369130a79e573376dcc7c661e->getId()); Mage::getModel('blastlucenesearch/blastlucenesearch')->markAsIndexRequiredForAllStores($_34f17fe369130a79e573376dcc7c661e->getId()); break; case Mage_Index_Model_Event::TYPE_DELETE: $_34f17fe369130a79e573376dcc7c661e = $_1b409d59e2b5e86c40205680bc8dc6e9->getDataObject(); $_1b409d59e2b5e86c40205680bc8dc6e9->addNewData('lucene_catalogsearch_delete_product_id', $_34f17fe369130a79e573376dcc7c661e->getId()); Mage::getModel('blastlucenesearch/blastlucenesearch')->markAsIndexRequiredForAllStores($_34f17fe369130a79e573376dcc7c661e->getId()); Mage::getModel('blastlucenesearch/blastlucenesearch')->removeProductFromIndex($_34f17fe369130a79e573376dcc7c661e->getId()); break; case Mage_Index_Model_Event::TYPE_MASS_ACTION: $_6d4c5347fadd5d50841d69bde33aa814 = $_1b409d59e2b5e86c40205680bc8dc6e9->getDataObject(); $_b43b6d06fd7d75536c252bfa5a329885 = array(); $_609e947144c00289e0606642ab264473 = false; $_b6e32dbc6dd48e43192921a711037667 = $_6d4c5347fadd5d50841d69bde33aa814->getAttributesData(); if (isset($_b6e32dbc6dd48e43192921a711037667['status'])) { $_609e947144c00289e0606642ab264473 = true; $_b43b6d06fd7d75536c252bfa5a329885['lucene_catalogsearch_status'] = $_b6e32dbc6dd48e43192921a711037667['status']; } if ($_6d4c5347fadd5d50841d69bde33aa814->getWebsiteIds()) { $_609e947144c00289e0606642ab264473 = true; $_b43b6d06fd7d75536c252bfa5a329885['lucene_catalogsearch_website_ids'] = $_6d4c5347fadd5d50841d69bde33aa814->getWebsiteIds(); $_b43b6d06fd7d75536c252bfa5a329885['lucene_catalogsearch_action_type'] = $_6d4c5347fadd5d50841d69bde33aa814->getActionType(); } if ($_609e947144c00289e0606642ab264473) { $_b43b6d06fd7d75536c252bfa5a329885['lucene_catalogsearch_product_ids'] = $_6d4c5347fadd5d50841d69bde33aa814->getProductIds(); if (is_array($_b43b6d06fd7d75536c252bfa5a329885['lucene_catalogsearch_product_ids'])) { foreach ($_b43b6d06fd7d75536c252bfa5a329885['lucene_catalogsearch_product_ids'] as $_e6eb4a94e64104f553246a6bcffa7983) { Mage::getModel('blastlucenesearch/blastlucenesearch')->markAsIndexRequiredForAllStores($_e6eb4a94e64104f553246a6bcffa7983); } } foreach ($_b43b6d06fd7d75536c252bfa5a329885 as $_7c1751c8c4070793ceb6cd27b5dba736 => $_9cd69ea62764c1ee80c6d6126d8fa54d) { $_1b409d59e2b5e86c40205680bc8dc6e9->addNewData($_7c1751c8c4070793ceb6cd27b5dba736, $_9cd69ea62764c1ee80c6d6126d8fa54d); } } break; } return $this; } protected function _isProductComposite($_e6eb4a94e64104f553246a6bcffa7983) { $_34f17fe369130a79e573376dcc7c661e = Mage::getModel('catalog/product')->load($_e6eb4a94e64104f553246a6bcffa7983); return $_34f17fe369130a79e573376dcc7c661e->isComposite(); } protected function _processEvent(Mage_Index_Model_Event $_1b409d59e2b5e86c40205680bc8dc6e9) { if ( !Mage::helper('php4u/version')->isMageCommunity() && (version_compare ( Mage::getVersion(), '1.9.0', '>=' ) && version_compare ( Mage::getVersion(), '1.9.9', '<=' )) ) { $this->_processEventOlder($_1b409d59e2b5e86c40205680bc8dc6e9); return; } elseif (Mage::getSingleton('blastlucenesearch/blastlucenesearch')->isMagentoVerLess14() == TRUE) { $this->_processEventOlder($_1b409d59e2b5e86c40205680bc8dc6e9); return; } $_d2c2a0552c85ff3aa1a15cb39fdd1d58 = $_1b409d59e2b5e86c40205680bc8dc6e9->getNewData(); if (!empty($_d2c2a0552c85ff3aa1a15cb39fdd1d58['lucene_catalogsearch_fulltext_reindex_all'])) { $this->reindexAll(); } else if (!empty($_d2c2a0552c85ff3aa1a15cb39fdd1d58['lucene_catalogsearch_delete_product_id'])) { $_e6eb4a94e64104f553246a6bcffa7983 = $_d2c2a0552c85ff3aa1a15cb39fdd1d58['lucene_catalogsearch_delete_product_id']; if (!$this->_isProductComposite($_e6eb4a94e64104f553246a6bcffa7983)) { $_9cd888572f4d1d7e63463c85e379c29b = $this->_getResource()->getRelationsByChild($_e6eb4a94e64104f553246a6bcffa7983); if (!empty($_9cd888572f4d1d7e63463c85e379c29b)) { $this->_getIndexer()->rebuildIndex(null, $_9cd888572f4d1d7e63463c85e379c29b); } } $this->_getIndexer()->cleanIndex(null, $_e6eb4a94e64104f553246a6bcffa7983) ->resetSearchResults(); } else if (!empty($_d2c2a0552c85ff3aa1a15cb39fdd1d58['lucene_catalogsearch_update_product_id'])) { $_e6eb4a94e64104f553246a6bcffa7983 = $_d2c2a0552c85ff3aa1a15cb39fdd1d58['lucene_catalogsearch_update_product_id']; $_d663c50c090b11a1ed86dd9724534a91 = array($_e6eb4a94e64104f553246a6bcffa7983); if (!$this->_isProductComposite($_e6eb4a94e64104f553246a6bcffa7983)) { $_9cd888572f4d1d7e63463c85e379c29b = $this->_getResource()->getRelationsByChild($_e6eb4a94e64104f553246a6bcffa7983); if (!empty($_9cd888572f4d1d7e63463c85e379c29b)) { $_d663c50c090b11a1ed86dd9724534a91 = array_merge($_d663c50c090b11a1ed86dd9724534a91, $_9cd888572f4d1d7e63463c85e379c29b); } } $this->_getIndexer()->rebuildIndex(null, $_d663c50c090b11a1ed86dd9724534a91) ->resetSearchResults(); } else if (!empty($_d2c2a0552c85ff3aa1a15cb39fdd1d58['lucene_catalogsearch_product_ids'])) { $_d663c50c090b11a1ed86dd9724534a91 = $_d2c2a0552c85ff3aa1a15cb39fdd1d58['lucene_catalogsearch_product_ids']; if (!empty($_d2c2a0552c85ff3aa1a15cb39fdd1d58['lucene_catalogsearch_website_ids'])) { $_92f8829c6841cffa48527403d7267db7 = $_d2c2a0552c85ff3aa1a15cb39fdd1d58['lucene_catalogsearch_website_ids']; $_e3b80621cf1442faedfc1fcceee1c2e2 = $_d2c2a0552c85ff3aa1a15cb39fdd1d58['lucene_catalogsearch_action_type']; foreach ($_92f8829c6841cffa48527403d7267db7 as $_d1ba233db86c1a35316a95ecb8e57084) { foreach (Mage::app()->getWebsite($_d1ba233db86c1a35316a95ecb8e57084)->getStoreIds() as $_40cfedb393b47f6f50e149c3e69322bd) { if ($_e3b80621cf1442faedfc1fcceee1c2e2 == 'remove') { $this->_getIndexer() ->cleanIndex($_40cfedb393b47f6f50e149c3e69322bd, $_d663c50c090b11a1ed86dd9724534a91) ->resetSearchResults(); } else if ($_e3b80621cf1442faedfc1fcceee1c2e2 == 'add') { $this->_getIndexer() ->rebuildIndex($_40cfedb393b47f6f50e149c3e69322bd, $_d663c50c090b11a1ed86dd9724534a91) ->resetSearchResults(); } } } } if (isset($_d2c2a0552c85ff3aa1a15cb39fdd1d58['lucene_catalogsearch_status'])) { $_d560f69471154245fa045c540dff1e5c = $_d2c2a0552c85ff3aa1a15cb39fdd1d58['lucene_catalogsearch_status']; if ($_d560f69471154245fa045c540dff1e5c == Mage_Catalog_Model_Product_Status::STATUS_ENABLED) { $this->_getIndexer() ->rebuildIndex(null, $_d663c50c090b11a1ed86dd9724534a91) ->resetSearchResults(); } else { $this->_getIndexer() ->cleanIndex(null, $_d663c50c090b11a1ed86dd9724534a91) ->resetSearchResults(); } } } } protected function _processEventOlder(Mage_Index_Model_Event $_1b409d59e2b5e86c40205680bc8dc6e9) { $_d2c2a0552c85ff3aa1a15cb39fdd1d58 = $_1b409d59e2b5e86c40205680bc8dc6e9->getNewData(); if (!empty($_d2c2a0552c85ff3aa1a15cb39fdd1d58['lucene_catalogsearch_fulltext_reindex_all'])) { $this->reindexAll(); } else if (!empty($_d2c2a0552c85ff3aa1a15cb39fdd1d58['lucene_catalogsearch_delete_product_id'])) { $_e6eb4a94e64104f553246a6bcffa7983 = $_d2c2a0552c85ff3aa1a15cb39fdd1d58['lucene_catalogsearch_delete_product_id']; $this->_getIndexer()->cleanIndex(null, $_e6eb4a94e64104f553246a6bcffa7983) ->resetSearchResults(); } else if (!empty($_d2c2a0552c85ff3aa1a15cb39fdd1d58['lucene_catalogsearch_update_product_id'])) { $_e6eb4a94e64104f553246a6bcffa7983 = $_d2c2a0552c85ff3aa1a15cb39fdd1d58['lucene_catalogsearch_update_product_id']; $this->_getIndexer()->rebuildIndex(null, $_e6eb4a94e64104f553246a6bcffa7983) ->resetSearchResults(); } else if (!empty($_d2c2a0552c85ff3aa1a15cb39fdd1d58['lucene_catalogsearch_product_ids'])) { $_d663c50c090b11a1ed86dd9724534a91 = $_d2c2a0552c85ff3aa1a15cb39fdd1d58['lucene_catalogsearch_product_ids']; if (!empty($_d2c2a0552c85ff3aa1a15cb39fdd1d58['lucene_catalogsearch_website_ids'])) { $_92f8829c6841cffa48527403d7267db7 = $_d2c2a0552c85ff3aa1a15cb39fdd1d58['lucene_catalogsearch_website_ids']; $_e3b80621cf1442faedfc1fcceee1c2e2 = $_d2c2a0552c85ff3aa1a15cb39fdd1d58['lucene_catalogsearch_action_type']; foreach ($_92f8829c6841cffa48527403d7267db7 as $_d1ba233db86c1a35316a95ecb8e57084) { foreach (Mage::app()->getWebsite($_d1ba233db86c1a35316a95ecb8e57084)->getStoreIds() as $_40cfedb393b47f6f50e149c3e69322bd) { if ($_e3b80621cf1442faedfc1fcceee1c2e2 == 'remove') { $this->_getIndexer() ->cleanIndex($_40cfedb393b47f6f50e149c3e69322bd, $_d663c50c090b11a1ed86dd9724534a91) ->resetSearchResults(); } else if ($_e3b80621cf1442faedfc1fcceee1c2e2 == 'add') { $this->_getIndexer() ->rebuildIndex($_40cfedb393b47f6f50e149c3e69322bd, $_d663c50c090b11a1ed86dd9724534a91) ->resetSearchResults(); } } } } if (isset($_d2c2a0552c85ff3aa1a15cb39fdd1d58['lucene_catalogsearch_status'])) { $_d560f69471154245fa045c540dff1e5c = $_d2c2a0552c85ff3aa1a15cb39fdd1d58['lucene_catalogsearch_status']; if ($_d560f69471154245fa045c540dff1e5c == Mage_Catalog_Model_Product_Status::STATUS_ENABLED) { $this->_getIndexer() ->rebuildIndex(null, $_d663c50c090b11a1ed86dd9724534a91) ->resetSearchResults(); } else { $this->_getIndexer() ->cleanIndex(null, $_d663c50c090b11a1ed86dd9724534a91) ->resetSearchResults(); } } } } public function reindexAll() { Mage::getSingleton('blastlucenesearch/lucene')->rebuildIndex(); } protected function _getIndexer() { return Mage::getSingleton('blastlucenesearch/lucene'); } }
?>
