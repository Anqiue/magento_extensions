<?php
 /*
 * Arcanum Dev AwardPoints
 *
 * NOTICE OF LICENSE
 *
 * This source file is subject to the Open Software License (OSL 3.0)
 * that is available through the world-wide-web at this URL:
 * http://opensource.org/licenses/osl-3.0.php
 * If you did not receive a copy of the license and are unable to
 * obtain it through the world-wide-web, please send an email
 * to arcanumdev@wafunotamago.com so we can send you a copy immediately.
 *
 * @category   Magento Sale Extension
 * @package    AwardPoints
 * @copyright  Copyright (c) 2012 Arcanum Dev. Y.K. (http://arcanumdev.wafunotamago.com)
 * @license    http://opensource.org/licenses/osl-3.0.php  Open Software License (OSL 3.0)
 */
 class Arcanumdev_Awardpoints_Model_Rule_Condition_Customerattribute_Params extends Mage_Rule_Model_Condition_Abstract{public function __construct(){parent::__construct();$this->setType('awardpoints/rule_condition_customerattribute_params')->setValue(null);}public function loadAttributeOptions(){$hlp=Mage::helper('awardpoints');$attributes=array();$customer=Mage::getModel('customer/customer');foreach ($customer->getAttributes() as $attribute){if ($attribute->getBackendModel()=="" && $attribute->getFrontendLabel()!=""){$attributes[$attribute->getAttributeCode()]=$attribute->getFrontendLabel();}}$this->setAttributeOption($attributes);return $this;}public function loadOperatorOptions(){$this->setOperatorOption(array('=='=>Mage::helper('awardpoints')->__('is'),'!='=>Mage::helper('awardpoints')->__('is not'),'>='=>Mage::helper('awardpoints')->__('equals or greater than'),'<='=>Mage::helper('awardpoints')->__('equals or less than'),'>'=>Mage::helper('awardpoints')->__('greater than'),'<'=>Mage::helper('awardpoints')->__('less than'),));return $this;}public function getExplicitApply(){switch ($this->getAttribute()) {case 'sku': case 'category_ids':return true;}$customer=Mage::getModel('customer/customer');foreach ($customer->getAttributes() as $attribute){if ($attribute->getBackendModel()=="" && $attribute->getFrontendLabel()!=""){if ($attribute->getAttributeCode()==$this->getAttribute()){switch ($attribute->getBackendType()) {case 'date':case 'datetime':return true;}}}}return false;}public function getValueElement(){$element=parent::getValueElement();$customer=Mage::getModel('customer/customer');foreach ($customer->getAttributes() as $attribute){if ($attribute->getBackendModel()=="" && $attribute->getFrontendLabel()!=""){if ($attribute->getAttributeCode()==$this->getAttribute()){switch ($attribute->getBackendType()) {case 'date':case 'datetime':$element->setImage(Mage::getDesign()->getSkinUrl('images/grid-cal.gif'));break;}}}}return $element;}public function getValueElementChooserUrl(){$url=false;switch ($this->getAttribute()) {case 'sku': case 'category_ids':$url='adminhtml/promo_widget/chooser'.'/attribute/'.$this->getAttribute();if ($this->getJsFormObject()) {$url .= '/form/'.$this->getJsFormObject();}break;}return $url!==false ? Mage::helper('adminhtml')->getUrl($url) : '';}public function asHtml(){if ($this->getAttribute()=='sku'){$html=$this->getTypeElement()->getHtml().Mage::helper('awardpoints')->__("%s %s",$this->getAttributeElement()->getHtml(),$this->getValueElement()->getHtml());if ($this->getId()!='1') {$html.= $this->getRemoveLinkHtml();}return $html;}return parent::asHtml();}public function getInputType(){switch ($this->getAttribute()) {case 'base_subtotal': case 'weight': case 'total_qty':return 'numeric';case 'shipping_method': case 'payment_method': case 'country_id': case 'region_id': case 'group_id':return 'select';}$customer=Mage::getModel('customer/customer');foreach ($customer->getAttributes() as $attribute){if ($attribute->getBackendModel()=="" && $attribute->getFrontendLabel()!=""){if ($attribute->getAttributeCode()==$this->getAttribute()){switch ($attribute->getBackendType()) {case 'date':case 'datetime':return 'date';case 'varchar':return 'string';case 'int':return 'numeric';case 'static':return 'select';}}}}return 'string';}public function getAttributeElement(){$element=parent::getAttributeElement();$element->setShowAsText(true);return $element;}public function getValueElementType(){switch ($this->getAttribute()) {case 'shipping_method':case 'payment_method':case 'country_id':case 'region_id':case 'group_id':return 'select';}$customer=Mage::getModel('customer/customer');foreach ($customer->getAttributes() as $attribute){if ($attribute->getBackendModel()=="" && $attribute->getFrontendLabel()!=""){if ($attribute->getAttributeCode()==$this->getAttribute()){switch ($attribute->getBackendType()) {case 'date':case 'datetime':return 'date';case 'text':return 'text';case 'int':return 'numeric';case 'static':return 'text';}}}}return 'text';}public function getValueSelectOptions(){if (!$this->hasData('value_select_options')) {$options=array();$customer=Mage::getModel('customer/customer');foreach ($customer->getAttributes() as $attribute){if ($attribute->getBackendModel()=="" && $attribute->getFrontendLabel()!=""){if ($attribute->getAttributeCode()==$this->getAttribute()){switch ($attribute->getBackendType()) {case 'static':default:$options=array();}}}}if ($options==array()){switch ($this->getAttribute()) {case 'confirmation':$options=Mage::getModel('adminhtml/system_config_source_yesno')->toOptionArray();break;case 'country_id':$options=Mage::getModel('adminhtml/system_config_source_country')->toOptionArray();break;case 'region_id':$options=Mage::getModel('adminhtml/system_config_source_allregion')->toOptionArray();break;case 'group_id':$options=Mage::getResourceModel('customer/group_collection') ->load()->toOptionArray();break;default:$options=array();}}$this->setData('value_select_options', $options);}return $this->getData('value_select_options');}public function validate(Varien_Object $object){$customerId=$object->getQuote()->getCustomerId();if ($customerId){$customer=Mage::getModel('customer/customer')->load($customerId);$datas=$customer->getData();return parent::validate($datas);}return false;}}